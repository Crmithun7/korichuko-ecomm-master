{% extends 'store/base.html' %}
{% load static %}
{% block content %}

<style>
  :root{
    /* Saffron & Pistachio (matches your home) */
    --brand-primary:#B55A1B; --brand-primary-600:#9F4F18;
    --brand-accent:#3E7F61; --brand-gold:#D7B56D;
    --brand-ivory:#FFF4EA; --panel-brd:#EED8C6;
    --text:#202020; --muted:#6B6B6B;
    --r-lg:16px; --ease:cubic-bezier(.2,.8,.2,1);
  }

  /* Ambient background */
  .sweet-bg{ position:fixed; inset:0; z-index:-3;
    background:
      radial-gradient(1200px 800px at 15% 20%, #B55A1B22 0%, transparent 60%),
      radial-gradient(1000px 800px at 85% 18%, #3E7F6122 0%, transparent 60%),
      linear-gradient(120deg, #fff4ea, #ffefe2 60%, #ffe8d2);
  }
  .ambient-blobs{ position:fixed; inset:-8vmax; z-index:-2; pointer-events:none;
    background:
      radial-gradient(closest-side, #ffffff26, transparent 70%) 12% 18%/46vmax 46vmax no-repeat,
      radial-gradient(closest-side, #B55A1B1a, transparent 70%) 80% 15%/44vmax 44vmax no-repeat,
      radial-gradient(closest-side, #3E7F6112, transparent 70%) 70% 82%/54vmax 54vmax no-repeat;
    filter: blur(22px);
    animation: fog-move 26s ease-in-out infinite alternate;
  }
  @keyframes fog-move{ 0%{ transform: translate3d(-2vmax,-1vmax,0) scale(1);} 100%{ transform: translate3d(2vmax,1vmax,0) scale(1.04);} }

  /* Glass cards + aurora border on hover */
  .glass{ background: rgba(255,255,255,.9); backdrop-filter: blur(12px) saturate(120%);
    border:1px solid var(--panel-brd); border-radius:var(--r-lg)!important;
    box-shadow:0 14px 28px rgba(181,90,27,.14), inset 0 1px 0 rgba(255,255,255,.55);
    position:relative; overflow:hidden; contain:content;
  }
  .glass.aurora::after{
    content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none; opacity:0;
    background: conic-gradient(from 10deg, #ffdca6, #ffe8c6, #f9e6cc, #ffdca6);
    -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
     mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude; padding:1px; transition:opacity .25s ease;
  }
  .glass.aurora:hover::after{ opacity:1; animation: spin 8s linear infinite }
  @keyframes spin{ to{ transform: rotate(360deg) } }

  /* Tilt */
  .tilt{ transform: perspective(900px) rotateX(var(--tx,0deg)) rotateY(var(--ty,0deg));
    transition: box-shadow .2s ease; will-change: transform;
  }
  .tilt:hover{ box-shadow:0 18px 40px rgba(181,90,27,.18) }

  /* Titles */
  .sweet-title{ background:linear-gradient(90deg,var(--brand-primary),var(--brand-accent));
    -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:800; letter-spacing:.3px;
  }
  .sweet-sub{ color:var(--muted) }

  /* Main image + lens zoom + glint */
  .stage{ position:relative; border-radius:12px; overflow:hidden; background:#fffdf8 }
  .main-image{ width:100%; height:100%; object-fit:cover; transition:transform .35s var(--ease), filter .35s var(--ease); }
  .glint{ position:absolute; inset:0; pointer-events:none; opacity:0;
    background: radial-gradient(180px 90px at var(--mx,50%) var(--my,40%), rgba(255,255,255,.55), transparent 60%);
    mix-blend-mode:soft-light; transition: opacity .25s ease;
  }
  .stage:hover .glint{ opacity:1 }
  .lens-zoom{ transform-origin: var(--ox,50%) var(--oy,50%); }

  /* Thumbnails */
  .thumb{ width:64px; height:64px; border-radius:12px; overflow:hidden; border:2px solid #f1dfce;
    background:#fffdfa; cursor:pointer; transition:.2s var(--ease); }
  .thumb:hover{ transform: translateY(-2px) }
  .thumb.active{ border-color:var(--brand-accent) }

  /* Buttons + ripple */
  .btn-success{ background:var(--brand-primary); border-color:var(--brand-primary); color:#fff;
    box-shadow:0 10px 24px rgba(181,90,27,.22); transition:transform .12s ease, filter .18s ease, box-shadow .18s ease;
  }
  .btn-success:hover{ transform:translateY(-1px); filter:brightness(1.05); background:var(--brand-primary-600) }
  .btn-warning{ background:#E9A23B; border-color:#E9A23B; color:#422b00 }
  .btn-warning:hover{ filter:brightness(1.05) }
  .btn-outline-secondary{ border-color:#d7c7b6; color:#5a4b3b }
  .ripple{ position:relative; overflow:hidden }
  .ripple > .rfx{ position:absolute; border-radius:50%; pointer-events:none; transform:scale(0);
    background:rgba(255,255,255,.35); filter:blur(2px); transition: transform .45s ease, opacity .6s ease;
  }

  /* Sticky buy dock */
  .buy-dock{ position:fixed; left:0; right:0; bottom:16px; z-index:30; display:none; }
  .buy-dock .dock{ margin:auto; max-width:960px; border-radius:999px; padding:.55rem .75rem;
    background:rgba(255,255,255,.9); backdrop-filter: blur(10px); border:1px solid var(--panel-brd);
    box-shadow:0 18px 40px rgba(0,0,0,.14);
  }
  .buy-dock.show{ display:block; animation: rise .28s var(--ease) both }
  @keyframes rise{ from{ transform: translateY(8px); opacity:0 } to{ transform:none; opacity:1 } }

  /* Confetti piece */
  .confetti{ position:fixed; width:6px; height:6px; border-radius:50%; pointer-events:none; z-index:60 }

  /* Tabs underline */
  .nav-tabs .nav-link{ color:var(--muted); position:relative; padding:.75rem 1rem; border:none }
  .nav-tabs .nav-link.active{ color:#3b2d22; background:transparent }
  .nav-tabs .nav-link::after{
    content:""; position:absolute; left:20%; right:20%; bottom:0; height:3px; border-radius:99px;
    background:linear-gradient(90deg,var(--brand-primary),var(--brand-gold));
    transform:scaleX(0); transform-origin:center; transition:transform .3s ease;
  }
  .nav-tabs .nav-link.active::after{ transform:scaleX(1) }

  /* Reveal */
  .reveal{ opacity:0; transform: translateY(10px); }
  .reveal.show{ opacity:1; transform:none; transition: opacity .55s var(--ease), transform .55s var(--ease) }

  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{ animation-duration:.001ms!important; animation-iteration-count:1!important; transition-duration:.001ms!important }
    .ambient-blobs{ display:none!important }
  }
</style>

<div class="sweet-bg"></div>
<div class="ambient-blobs"></div>

<div class="container py-5">
  <div class="text-center mb-4 reveal show">
    <h2 class="sweet-title">Product Details</h2>
    <p class="sweet-sub">crafted with the same vibe as your home page ✨</p>
  </div>

  <div class="row g-5 align-items-start reveal show" id="productTop">
    <!-- Gallery -->
    <div class="col-lg-5">
      <div class="glass aurora tilt p-3" id="imgCard">
        <div class="stage ratio ratio-1x1 mb-3" id="stage">
          {% if product.image %}
            <img id="mainImage" class="main-image lens-zoom" src="{{ product.image.url }}" alt="{{ product.name }}" decoding="async" />
          {% else %}
            <div class="d-flex align-items-center justify-content-center bg-light rounded w-100 h-100">No image</div>
          {% endif %}
          <i class="glint" aria-hidden="true"></i>
        </div>

        <!-- arrows -->
        <button class="btn btn-light position-absolute top-50 start-0 translate-middle-y ms-2 rounded-circle" style="width:40px;height:40px" onclick="previousImage()" aria-label="Prev">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="btn btn-light position-absolute top-50 end-0 translate-middle-y me-2 rounded-circle" style="width:40px;height:40px" onclick="nextImage()" aria-label="Next">
          <i class="bi bi-chevron-right"></i>
        </button>

        <!-- thumbs (add more later) -->
        <div class="d-flex gap-2 justify-content-center pt-2" id="thumbs">
          {% if product.image %}
          <div class="thumb active" data-src="{{ product.image.url }}"><img src="{{ product.image.url }}" class="w-100 h-100" style="object-fit:cover" alt="thumb"/></div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Info -->
    <div class="col-lg-7">
      <div class="glass aurora tilt p-4" id="infoCard">
        <div class="mb-2">
          <h1 class="sweet-title fw-bold mb-2" style="font-size:clamp(1.6rem,2.2vw,2.2rem)">{{ product.name }}</h1>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-success rounded-pill">Fresh</span>
            <div class="text-warning" aria-hidden="true"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i></div>
            <small class="text-muted">(245 reviews)</small>
          </div>
        </div>

        <div class="my-3 d-flex align-items-center gap-3">
          {% if product.sale_price %}
            <span class="display-6 fw-800 text-success">₹{{ product.sale_price }}</span>
            <span class="fs-5 text-muted text-decoration-line-through">₹{{ product.regular_price }}</span>
          {% else %}
            <span class="display-6 fw-800 text-success">₹{{ product.regular_price }}</span>
          {% endif %}
        </div>

        <p class="text-muted">{{ product.description|default:"Handcrafted sweets made fresh daily with premium ingredients." }}</p>

        {% if product.size_display %}
        <div class="mb-3">
          <h6 class="fw-bold mb-2">Weight</h6>
          <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="w" id="w1" checked><label class="btn btn-outline-success rounded-pill me-2" for="w1">{{ product.size_display }}</label>
            <input type="radio" class="btn-check" name="w" id="w2"><label class="btn btn-outline-secondary rounded-pill me-2" for="w2">1 Kg</label>
            <input type="radio" class="btn-check" name="w" id="w3"><label class="btn btn-outline-secondary rounded-pill me-2" for="w3">2 Kg</label>
            <input type="radio" class="btn-check" name="w" id="w4"><label class="btn btn-outline-secondary rounded-pill" for="w4">5 Kg</label>
          </div>
        </div>
        {% endif %}

        <div class="mb-4" id="buyZone">
          <div class="row g-3 align-items-center">
            <div class="col-auto">
              <div class="input-group" style="width:140px">
                <button class="btn btn-outline-secondary" type="button" onclick="decQty()" aria-label="Decrease">−</button>
                <input id="qty" class="form-control text-center" type="number" min="1" value="1" aria-label="Quantity">
                <button class="btn btn-outline-secondary" type="button" onclick="incQty()" aria-label="Increase">+</button>
              </div>
            </div>
            <div class="col">
              <form action="{% url 'store:add_to_cart' product.id %}" method="post" class="d-inline add-to-cart-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-success rounded-pill px-4 py-2 me-2 ripple btn-cta"><i class="bi bi-cart-plus me-2"></i>Add to Cart</button>
              </form>
              <button class="btn btn-warning rounded-pill px-4 py-2 ripple">Buy Now</button>
              <button class="btn btn-outline-secondary rounded-circle p-2 ms-1" aria-label="Wishlist"><i class="bi bi-heart"></i></button>
            </div>
          </div>
        </div>

        <div class="small">
          <div class="mb-1"><span class="fw-semibold">SKU:</span> <span class="text-muted">{{ product.id|default:"GRFRS554SHJJ" }}</span></div>
          <div class="mb-1"><span class="fw-semibold">Tags:</span> <span class="text-muted">{{ product.category.name }}, Saffron, Pistachio</span></div>
          <div><span class="fw-semibold">Share:</span>
            <a href="#" class="ms-2" style="color:#3b5998"><i class="bi bi-facebook"></i></a>
            <a href="#" class="ms-2" style="color:#1da1f2"><i class="bi bi-twitter"></i></a>
            <a href="#" class="ms-2" style="color:#25d366"><i class="bi bi-whatsapp"></i></a>
            <a href="#" class="ms-2" style="color:#e4405f"><i class="bi bi-instagram"></i></a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="row mt-4 reveal">
    <div class="col-12 glass p-3">
      <ul class="nav nav-tabs justify-content-center mb-3" role="tablist">
        <li class="nav-item"><button class="nav-link active fw-semibold" data-bs-toggle="tab" data-bs-target="#tab-desc" type="button">Description</button></li>
        <li class="nav-item"><button class="nav-link fw-semibold" data-bs-toggle="tab" data-bs-target="#tab-info" type="button">Additional Info</button></li>
        <li class="nav-item"><button class="nav-link fw-semibold" data-bs-toggle="tab" data-bs-target="#tab-rev" type="button">Reviews</button></li>
      </ul>
      <div class="tab-content p-3 p-md-4">
        <div class="tab-pane fade show active" id="tab-desc">
          <p class="text-muted">{{ product.description|default:"Fresh, rich and festive. Perfect for gifting and celebrations." }}</p>
        </div>
        <div class="tab-pane fade" id="tab-info"><p class="text-muted">Additional product information goes here.</p></div>
        <div class="tab-pane fade" id="tab-rev"><p class="text-muted">Customer reviews appear here.</p></div>
      </div>
    </div>
  </div>

  <!-- Related -->
  <div class="mt-5 reveal">
    <div class="text-center mb-4">
      <h6 class="text-muted text-uppercase mb-1">Related</h6>
      <h3 class="fw-bold">Explore <span class="sweet-title">Related Products</span></h3>
    </div>
    <div class="row g-4">
      {% for related in related_products %}
      <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="glass aurora tilt p-2 h-100" data-tilt-card>
          <div class="position-relative ratio ratio-1x1 rounded overflow-hidden">
            {% if related.image %}
            <img src="{{ related.image.url }}" class="w-100 h-100" style="object-fit:cover; transition:transform .35s var(--ease)" loading="lazy" alt="{{ related.name }}"
                 onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='none'">
            {% else %}
            <div class="d-flex align-items-center justify-content-center bg-light">No image</div>
            {% endif %}
          </div>
          <div class="p-3 text-center">
            <div class="text-muted small">{{ related.category.name }}</div>
            <h6 class="fw-bold mb-1" style="color:#3b2d22">{{ related.name }}</h6>
            <div class="mb-2">
              {% if related.sale_price %}
                <span class="fw-bold" style="color:var(--brand-primary)">₹{{ related.sale_price }}</span>
                <span class="text-muted text-decoration-line-through ms-1">₹{{ related.regular_price }}</span>
              {% else %}
                <span class="fw-bold" style="color:var(--brand-primary)">₹{{ related.regular_price }}</span>
              {% endif %}
            </div>
            <form action="{% url 'store:add_to_cart' related.id %}" method="post" class="add-to-cart-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm rounded-pill px-4 ripple"><i class="bi bi-cart-plus me-1"></i>Add</button>
            </form>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12 text-center text-muted">No related products.</div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Sticky buy dock -->
<div class="buy-dock" id="buyDock">
  <div class="dock container">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        {% if product.image %}<img src="{{ product.image.url }}" alt="" width="42" height="42" class="rounded" style="object-fit:cover">{% endif %}
        <div>
          <div class="fw-bold">{{ product.name }}</div>
          <div class="small text-muted">
            {% if product.sale_price %}₹{{ product.sale_price }}{% else %}₹{{ product.regular_price }}{% endif %}
          </div>
        </div>
      </div>
      <form action="{% url 'store:add_to_cart' product.id %}" method="post" class="m-0 add-to-cart-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-success rounded-pill px-4 ripple"><i class="bi bi-cart-plus me-2"></i>Add to Cart</button>
      </form>
    </div>
  </div>
</div>

<script>
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  /* Tilt (desktop only) */
  function attachTilt(el){
    if(!el || (matchMedia && matchMedia('(pointer: coarse)').matches)) return;
    const clamp=(n,a,b)=>Math.max(a,Math.min(b,n)); let raf=null;
    function onMove(e){
      const r=el.getBoundingClientRect();
      const dx=(e.clientX-(r.left+r.width/2))/r.width;
      const dy=(e.clientY-(r.top+r.height/2))/r.height;
      const tx=clamp((-dy)*6,-6,6), ty=clamp((dx)*6,-6,6);
      if(raf) cancelAnimationFrame(raf);
      raf=requestAnimationFrame(()=>{ el.style.setProperty('--tx',tx+'deg'); el.style.setProperty('--ty',ty+'deg'); });
    }
    function reset(){ el.style.setProperty('--tx','0deg'); el.style.setProperty('--ty','0deg'); }
    el.addEventListener('pointermove', onMove, {passive:true});
    el.addEventListener('pointerleave', reset);
  }
  attachTilt(document.getElementById('imgCard'));
  attachTilt(document.getElementById('infoCard'));
  document.querySelectorAll('[data-tilt-card]').forEach(attachTilt);

  /* Reveal on scroll */
  (function(){
    const els=[...document.querySelectorAll('.reveal')];
    if(!('IntersectionObserver' in window)){ els.forEach(e=>e.classList.add('show')); return; }
    const io=new IntersectionObserver(es=>{ es.forEach(x=>{ if(x.isIntersecting){ x.target.classList.add('show'); io.unobserve(x.target);} });},{threshold:.14});
    els.forEach(e=>io.observe(e));
  })();

  /* Image lens zoom + glint follow */
  (function(){
    const stage=document.getElementById('stage'); const img=document.getElementById('mainImage'); const glint=stage?.querySelector('.glint');
    if(!stage || !img) return;
    stage.addEventListener('pointermove', (e)=>{
      const r=stage.getBoundingClientRect();
      const ox=((e.clientX-r.left)/r.width)*100, oy=((e.clientY-r.top)/r.height)*100;
      img.style.setProperty('--ox', ox+'%'); img.style.setProperty('--oy', oy+'%');
      glint?.style.setProperty('--mx', ox+'%'); glint?.style.setProperty('--my', oy+'%');
      img.classList.add('lens-zoom'); img.style.transform='scale(1.08)';
    });
    stage.addEventListener('pointerleave', ()=>{
      img.style.transform=''; img.classList.remove('lens-zoom');
    });
  })();

  /* Thumbs + prev/next (works even with a single image) */
  (function(){
    const main=document.getElementById('mainImage'); const thumbs=[...document.querySelectorAll('.thumb')];
    if(!main || !thumbs.length) return;
    let idx=0; const list=thumbs.map(t=>t.dataset.src);
    function show(i){
      idx=(i+list.length)%list.length;
      thumbs.forEach((t,j)=>t.classList.toggle('active', j===idx));
      main.style.opacity=.2; setTimeout(()=>{ main.src=list[idx]; main.style.opacity=1; },120);
    }
    thumbs.forEach((t,i)=> t.addEventListener('click', ()=> show(i)));
    window.nextImage = ()=> list.length>1 && show(idx+1);
    window.previousImage = ()=> list.length>1 && show(idx-1);
  })();

  /* Quantity */
  window.incQty = ()=>{ const i=document.getElementById('qty'); i.value=(parseInt(i.value||'1',10))+1; };
  window.decQty = ()=>{ const i=document.getElementById('qty'); const v=parseInt(i.value||'1',10); if(v>1) i.value=v-1; };

  /* Ripple */
  document.addEventListener('click', (e)=>{
    const b=e.target.closest('.ripple'); if(!b) return;
    const r=document.createElement('span'); r.className='rfx';
    const rect=b.getBoundingClientRect(); const size=Math.max(rect.width,rect.height);
    Object.assign(r.style,{ width:size+'px', height:size+'px',
      left:(e.clientX-rect.left-size/2)+'px', top:(e.clientY-rect.top-size/2)+'px' });
    b.appendChild(r);
    requestAnimationFrame(()=>{ r.style.transform='scale(1.6)'; r.style.opacity='0'; });
    setTimeout(()=>r.remove(), 650);
  }, {passive:true});

  /* Sticky buy dock: appears when #buyZone leaves viewport */
  (function(){
    const dock=document.getElementById('buyDock'); const target=document.getElementById('buyZone');
    if(!('IntersectionObserver' in window) || !dock || !target) return;
    const io=new IntersectionObserver(([e])=>{
      dock.classList.toggle('show', !e.isIntersecting);
    }, {threshold:0, rootMargin:'-20% 0px -65% 0px'});
    io.observe(target);
  })();

  /* Fly-to-cart + confetti on add-to-cart submit (non-blocking, works with your AJAX or normal submit) */
  (function(){
    function flyToCart(originEl){
      if(reduce) return;
      const cart=document.getElementById('cart-badge'); if(!cart||!originEl) return;
      const rect=originEl.getBoundingClientRect(); const cRect=cart.getBoundingClientRect();
      const ghost=originEl.cloneNode(true);
      ghost.style.cssText=`position:fixed; left:${rect.left}px; top:${rect.top}px; width:${rect.width}px; height:${rect.height}px; object-fit:cover; z-index:55; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.15)`;
      document.body.appendChild(ghost);
      ghost.animate([
        { transform:'translate(0,0) scale(1)', opacity:1 },
        { transform:`translate(${cRect.left-rect.left}px, ${cRect.top-rect.top}px) scale(.15)`, opacity:.2 }
      ], { duration:700, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards' }).onfinish=()=>ghost.remove();
    }
    function confettiBurst(x,y){
      if(reduce) return;
      const colors=['#ff7a00','#ffc155','#ff4d6d','#3E7F61','#fff'];
      for(let i=0;i<12;i++){
        const p=document.createElement('i'); p.className='confetti';
        p.style.left=x+'px'; p.style.top=y+'px'; p.style.background=colors[i%colors.length];
        document.body.appendChild(p);
        const dx=(Math.random()-0.5)*180, dy= -(80+Math.random()*100);
        p.animate([{transform:'translate(0,0)',opacity:1},{transform:`translate(${dx}px, ${dy}px)`,opacity:0}],
          {duration:800+Math.random()*500,easing:'cubic-bezier(.2,.8,.2,1)',fill:'forwards'}).onfinish=()=>p.remove();
      }
    }
    document.addEventListener('submit', (e)=>{
      const form=e.target.closest('.add-to-cart-form'); if(!form) return;
      const img=document.getElementById('mainImage'); flyToCart(img);
      const b=form.querySelector('button'); if(b){ const r=b.getBoundingClientRect(); confettiBurst(r.left+r.width/2, r.top); }
    }, true);
  })();

  /* Tilt handler (shared) already attached above */
  (function(){
    const els=[document.getElementById('imgCard'), document.getElementById('infoCard'), ...document.querySelectorAll('[data-tilt-card]')].filter(Boolean);
    els.forEach(el=>{
      el.addEventListener('pointermove', (e)=>{
        const r=el.getBoundingClientRect();
        const dx=(e.clientX-(r.left+r.width/2))/r.width;
        const dy=(e.clientY-(r.top+r.height/2))/r.height;
        el.style.setProperty('--tx', (-dy*6).toFixed(2)+'deg');
        el.style.setProperty('--ty', (dx*6).toFixed(2)+'deg');
      }, {passive:true});
      el.addEventListener('pointerleave', ()=>{ el.style.setProperty('--tx','0deg'); el.style.setProperty('--ty','0deg'); });
    });
  })();
</script>

{% endblock %}
