{% extends 'store/base.html' %}
{% load static %}
{% block content %}

<style>
  /* === Theme sync with Home === */
  .kc-scene{ --ambient-url: url('/media/banners/snacks-ambient.jpg'); }
  :root{
    --snack:#ff7a00; --snack-2:#ffc155; --berry:#ff4d6d;
    --cocoa:#2b170e; --ink:#3a1d0f; --line:#efdfcd;
    --ease:cubic-bezier(.2,.8,.2,1); --r-lg:18px; --sh1:0 14px 32px rgba(43,23,14,.10);
  }

  /* === Ambient scene with extra glow === */
  .shop-scene{
    position:relative; border-radius:20px; overflow:hidden;
    background:
      radial-gradient(120% 120% at 10% 0%, #ffe4c7 0%, #fff7ef 45%, #fff 100%),
      linear-gradient(120deg, #fff7ef, #ffe4c7, #ffdcd1);
    background-size:120% 120%, 200% 200%;
    animation:bgShift 18s ease-in-out infinite;
    padding:14px;
  }
  .shop-scene::before{
    content:""; position:absolute; inset:0; z-index:0; pointer-events:none;
    background-image:var(--ambient-url); background-size:cover; background-position:center;
    opacity:.16; mix-blend-mode:multiply; transform:scale(1.05);
    animation:slowPan 40s ease-in-out infinite alternate;
  }
  .shop-scene::after{
    content:""; position:absolute; inset:-25% -10%; z-index:0; pointer-events:none;
    background:
      conic-gradient(from 180deg at 70% 20%, rgba(255,255,255,.28), transparent 20% 60%, rgba(255,255,255,.22) 80%, transparent),
      radial-gradient(240px 200px at 12% 8%, rgba(255,170,110,.16), transparent 60%),
      radial-gradient(260px 220px at 88% 90%, rgba(255,140,160,.14), transparent 60%);
    animation:glowFloat 24s ease-in-out infinite;
  }
  /* Canvas particles live under content */
  .scene-particles{
    position:absolute; inset:0; z-index:0; pointer-events:none; opacity:.65; mix-blend-mode:soft-light;
  }

  /* === Filter glass === */
  .filter-card{
    position:relative; background:linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.94));
    border:1px solid var(--line); border-radius:18px; box-shadow:var(--sh1); backdrop-filter:blur(6px); overflow:hidden;
  }
  .filter-card::after{
    content:""; position:absolute; inset:-40% -10%; pointer-events:none;
    background:conic-gradient(from 140deg at 80% 10%, rgba(255,255,255,.35), transparent 35% 65%, rgba(255,255,255,.25) 85%, transparent);
    animation:glowFloat 22s ease-in-out infinite;
  }
  .filter-title{ display:flex; gap:.5rem; align-items:center; font-weight:900; color:var(--cocoa) }
  .btn-apply{
    background:linear-gradient(135deg,var(--snack),var(--snack-2)); color:#3a1d0f; font-weight:900;
    border:none; border-radius:999px; box-shadow:0 12px 28px rgba(255,138,0,.25);
    position:relative; overflow:hidden; transform:translateZ(0);
  }
  .btn-apply::before{
    content:""; position:absolute; inset:0;
    background:linear-gradient(110deg,transparent 30%,rgba(255,255,255,.45) 50%,transparent 70%);
    transform:translateX(-130%); transition:transform .65s ease;
  }
  .btn-apply:hover{ transform:translateY(-1px) }
  .btn-apply:hover::before{ transform:translateX(130%) }
  .btn-apply.mag{ transition: transform .2s var(--ease) } /* magnetic */

  .cat-list .list-group-item{
    border:none; border-radius:12px; margin:.24rem 0; background:#fff; display:flex; align-items:center; justify-content:space-between;
    transition:.22s var(--ease);
  }
  .cat-list .list-group-item:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.06) }
  .cat-list .list-group-item.active{
    background:linear-gradient(90deg,var(--snack),var(--snack-2)); color:#3a1d0f; font-weight:900; box-shadow:0 10px 24px rgba(255,138,0,.25);
  }

  /* === Toolbar sheen === */
  .toolbar{
    background:#fff; border:1px solid var(--line); border-radius:16px; padding:.5rem .75rem;
    box-shadow:0 8px 18px rgba(16,22,26,.06); position:relative; overflow:hidden;
  }
  .toolbar::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:linear-gradient(110deg, transparent 40%, rgba(255,255,255,.5) 50%, transparent 60%);
    transform:translateX(-120%); animation:toolbarShine 6s var(--ease) infinite;
  }
  .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .6rem; border-radius:999px;
    border:1px dashed var(--line); background:#fffdf8; color:#2b170e; font-weight:800; font-size:.9rem }

  /* === Product card 3D tilt + glint === */
  .product-card{
    position:relative; border:1px solid var(--line); border-radius:16px; background:#fff;
    box-shadow:0 10px 24px rgba(16,22,26,.06); overflow:hidden; transform-style:preserve-3d;
    transition: transform .35s var(--ease), box-shadow .25s ease; will-change: transform;
  }
  .product-card:hover{ transform:translateY(-6px) rotateX(var(--rx,0deg)) rotateY(var(--ry,0deg)); box-shadow:0 18px 40px rgba(16,22,26,.14) }
  .product-card::before{
    content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none; opacity:0;
    background:conic-gradient(from 0deg, var(--snack), var(--snack-2), var(--snack));
    -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
     mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude; transition:opacity .25s ease;
  }
  .product-card:hover::before{ opacity:1; animation:spinBorder 6s linear infinite }

  .stage{
    position:relative; aspect-ratio:4/3; overflow:hidden;
    background:radial-gradient(120% 100% at 50% 0%, #fff 0, #fff7ee 60%, #fff2e0 100%);
    transform:translateZ(.01px);
  }
  .stage img{ width:100%; height:100%; object-fit:contain; transition: transform .45s var(--ease) }
  .product-card:hover .stage img{ transform:translateY(-2px) scale(1.04) }

  /* Cursor glint following mouse */
  .stage::after{
    content:""; position:absolute; inset:0; pointer-events:none; opacity:0;
    background:radial-gradient(160px 80px at var(--mx,50%) var(--my,40%), rgba(255,255,255,.55), transparent 60%);
    mix-blend-mode:soft-light; transition:opacity .25s ease;
  }
  .product-card:hover .stage::after{ opacity:1 }

  /* Skeleton + blur-up */
  .skeleton{ position:absolute; inset:0; background:linear-gradient(90deg,#f3efe8 25%,#fff7ee 37%,#f3efe8 63%);
    background-size:400% 100%; animation:shimmer 1.1s linear infinite; }
  .lazy-blur{ filter:blur(14px); transform:scale(1.03); }
  .lazy-blur.is-loaded{ filter:none; transform:none; transition:filter .35s ease, transform .35s ease }
  .skeleton.hide{ display:none }

  /* Badges + fav */
  .badge-sale{
    position:absolute; top:8px; left:8px; border-radius:999px; padding:.25rem .55rem; font-weight:800;
    background:linear-gradient(135deg,var(--berry),#ff6b88); color:#fff; box-shadow:0 6px 18px rgba(255,77,109,.25);
    animation:badgeBob 2.2s ease-in-out infinite;
  }
  .fav{
    position:absolute; top:8px; right:8px; width:36px; height:36px; display:grid; place-items:center;
    border-radius:50%; background:rgba(255,255,255,.9); border:1px solid var(--line); color:#b66a45; transition:transform .2s ease, color .2s ease;
  }
  .fav:hover{ transform:translateY(-2px) } .fav.active{ color:#ff4d6d }

  .title{
    margin:0; font-weight:800; color:var(--cocoa); line-height:1.25;
    display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; overflow:hidden;
  }
  .meta{ color:#7d6a5c; font-size:.9rem }
  .price-now{ font-weight:900; color:#1b7f30 }
  .price-old{ color:#9b897f; text-decoration:line-through; margin-left:.35rem }

  /* Quickbar reveal + buttons */
  .quickbar{ display:flex; justify-content:center; gap:.5rem; transform:translateY(8px); opacity:0; transition:.25s var(--ease) }
  .product-card:hover .quickbar{ transform:none; opacity:1 }
  .btn-add{
    --bg:linear-gradient(135deg,var(--snack),var(--snack-2));
    background:var(--bg); color:#3a1d0f; border:none; border-radius:999px; font-weight:900; position:relative; overflow:hidden;
    box-shadow:0 12px 28px rgba(255,138,0,.22); padding:.45rem .9rem;
    transition:transform .18s ease, filter .18s ease, box-shadow .18s ease; transform:translateZ(0);
  }
  .btn-add:hover{ transform:translateY(-1px); filter:saturate(1.05) }
  .btn-add .spark{ position:absolute; inset:0; pointer-events:none; opacity:0 }
  .btn-add:hover .spark{ opacity:.9; animation:sparkle 1.4s linear infinite }
  .btn-add.mag{ transition: transform .2s var(--ease) } /* magnetic */
  .ripple{ position:absolute; border-radius:50%; transform:translate(-50%, -50%); pointer-events:none;
    background:rgba(255,255,255,.55); animation:ripple .6s ease-out forwards }

  /* Scroll reveal */
  .reveal{ opacity:0; transform:translateY(18px) scale(.985); }
  .reveal.in{ opacity:1; transform:none; transition: transform .7s var(--ease), opacity .7s var(--ease) }
  .reveal.in[style*="--delay"]{ transition-delay: var(--delay) }

  /* Back-to-top & progress */
  .back-top{
    position:fixed; right:16px; bottom:18px; width:44px; height:44px; border-radius:50%;
    display:grid; place-items:center; border:1px solid var(--line); background:#fff; color:#000; z-index:24; box-shadow:var(--sh1);
    opacity:0; transform:translateY(10px); transition:.25s ease;
  }
  .back-top.show{ opacity:1; transform:none }
  .scroll-progress{
    position:sticky; top:0; height:4px; width:100%; z-index:30; background:linear-gradient(90deg, var(--snack), var(--snack-2));
    transform-origin:left; transform:scaleX(0);
  }

  /* Keyframes */
  @keyframes bgShift{0%,100%{background-position:0% 50%,0% 50%}50%{background-position:100% 50%,100% 50%}}
  @keyframes slowPan{0%{transform:scale(1.05) translateX(0)}100%{transform:scale(1.08) translateX(-1.2%)}}
  @keyframes glowFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
  @keyframes spinBorder{to{ transform:rotate(360deg) }}
  @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  @keyframes badgeBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
  @keyframes sparkle{
    0%{ background:
      radial-gradient(circle at 12% 22%, rgba(255,255,255,.55) 0 2px, transparent 3px),
      radial-gradient(circle at 78% 32%, rgba(255,255,255,.35) 0 2px, transparent 3px),
      radial-gradient(circle at 40% 76%, rgba(255,255,255,.35) 0 2px, transparent 3px); }
    50%{ background:
      radial-gradient(circle at 22% 28%, rgba(255,255,255,.45) 0 2px, transparent 3px),
      radial-gradient(circle at 70% 46%, rgba(255,255,255,.35) 0 2px, transparent 3px),
      radial-gradient(circle at 45% 86%, rgba(255,255,255,.35) 0 2px, transparent 3px); }
    100%{ background:
      radial-gradient(circle at 12% 22%, rgba(255,255,255,.55) 0 2px, transparent 3px),
      radial-gradient(circle at 78% 32%, rgba(255,255,255,.35) 0 2px, transparent 3px),
      radial-gradient(circle at 40% 76%, rgba(255,255,255,.35) 0 2px, transparent 3px); }
  }
  @keyframes ripple{ from{ width:0; height:0; opacity:.6 } to{ width:240px; height:240px; opacity:0 } }

  @media (prefers-reduced-motion: reduce){
    *,*::before,*::after{ animation-duration:.001ms!important; animation-iteration-count:1!important; transition-duration:.001ms!important; }
    .scene-particles{ display:none }
  }
</style>

<div class="shop-scene">
  <!-- particles canvas -->
  <canvas class="scene-particles" id="snackParticles" aria-hidden="true"></canvas>
  <!-- scroll progress -->
  <div class="scroll-progress"></div>

  <div class="row g-4 position-relative" style="z-index:1">
    <!-- SIDEBAR -->
    <aside class="col-lg-3">
      <div class="filter-card p-4 rounded-4 sticky-top reveal" style="top:5.5rem" data-delay="0.05s">
        <h5 class="filter-title mb-3"><i class="bi bi-sliders"></i> Filter</h5>

        <form method="get" action="{% url 'store:shop' %}" id="filterForm">
          <!-- Price -->
          <div class="mb-4">
            <label class="small text-secondary mb-1 d-flex justify-content-between">
              <span>Price</span>
              <span class="fw-bold text-success">₹<span id="rangeVal">{{ max_price|default:'1000' }}</span></span>
            </label>
            <input id="priceRange" type="range" class="form-range" min="0" max="1000" step="10"
                   name="max_price" value="{{ max_price|default:'1000' }}">
            <div class="d-flex justify-content-between small text-muted"><span>₹0</span><span>₹1000</span></div>
          </div>

          <!-- Category -->
          <div class="mb-4">
            <label class="small text-secondary mb-1">Category</label>
            <ul class="list-group cat-list small">
              <li class="list-group-item {% if not request.GET.category %}active{% endif %}">
                <a href="{% url 'store:shop' %}{% if max_price %}?max_price={{ max_price }}{% endif %}"
                   class="text-decoration-none {% if not request.GET.category %}text-dark{% endif %}">All</a>
              </li>
              {% for category in categories %}
              <li class="list-group-item d-flex {% if request.GET.category == category.slug %}active{% endif %}">
                <a href="{% url 'store:shop' %}?category={{ category.slug }}{% if max_price %}&max_price={{ max_price }}{% endif %}"
                   class="text-decoration-none {% if request.GET.category == category.slug %}text-dark{% endif %}">{{ category.name }}</a>
                {% if request.GET.category == category.slug and max_price %}<small class="text-dark-emphasis ms-auto">₹≤{{ max_price }}</small>{% endif %}
              </li>
              {% endfor %}
            </ul>
          </div>

          <button type="submit" class="btn btn-apply btn-sm w-100 btn-animated">Apply Filters</button>
        </form>
      </div>
    </aside>

    <!-- MAIN GRID -->
    <section class="col-lg-9">
      <!-- Toolbar -->
      <div class="toolbar d-flex align-items-center justify-content-between mb-4 reveal" data-delay="0.08s">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="fw-bold">{{ products|length }} goods</span>
          {% if request.GET.category %}
            <span class="chip"><i class="bi bi-tag"></i> {{ request.GET.category|title }}
              <a href="{% url 'store:shop' %}?{% if max_price %}max_price={{ max_price }}{% endif %}" title="Clear">×</a>
            </span>
          {% endif %}
          {% if max_price %}
            <span class="chip"><i class="bi bi-currency-rupee"></i> ≤ {{ max_price }}
              <a href="{% url 'store:shop' %}?{% if request.GET.category %}category={{ request.GET.category }}{% endif %}" title="Clear">×</a>
            </span>
          {% endif %}
        </div>

        <div class="input-group input-group-sm" style="max-width: 260px">
          <label class="input-group-text bg-light fw-semibold" for="sort-select">
            <i class="bi bi-arrow-down-up me-1"></i>Sort
          </label>
          <select id="sort-select" class="form-select bg-white" onchange="location = this.value;">
            <option value="{% url 'store:shop' %}?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}sort=popular" {% if request.GET.sort == 'popular' or not request.GET.sort %}selected{% endif %}>Popular</option>
            <option value="{% url 'store:shop' %}?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}sort=price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
            <option value="{% url 'store:shop' %}?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}sort=price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
          </select>
        </div>
      </div>

      <!-- Products -->
      <div class="row g-4">
        {% for product in products %}
        <div class="col-md-6 col-xl-4 reveal" data-delay="{{ forloop.counter0|add:'1'|divisibleby:3|yesno:'0.10s,0.06s' }}">
          <article class="product-card h-100" data-tilt>
            <div class="stage">
              {% if product.on_sale or product.sale_price %}<span class="badge-sale">Sale</span>{% endif %}
              <button class="fav" type="button" aria-label="Save"><i class="bi bi-heart"></i></button>

              <div class="skeleton" aria-hidden="true"></div>
              <a href="{% url 'store:product_detail' product.id %}">
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="lazy-blur" loading="lazy" decoding="async">
              </a>
            </div>

            <div class="p-3 text-center">
              <h6 class="title" title="{{ product.name }}">
                <a href="{% url 'store:product_detail' product.id %}" class="stretched-link text-decoration-none text-dark">{{ product.name }}</a>
              </h6>

              {% if product.size_display %}
                <div class="meta mb-1">{{ product.size_display }}</div>
              {% elif product.size_value and product.size %}
                <div class="meta mb-1">{{ product.size_value|floatformat:0 }} {{ product.size.abbreviation }}</div>
              {% endif %}

              <div class="mb-2">
                {% if product.sale_price %}
                  <span class="price-now">₹{{ product.sale_price }}</span>
                  <span class="price-old">₹{{ product.regular_price }}</span>
                {% else %}
                  <span class="price-now">₹{{ product.regular_price }}</span>
                {% endif %}
              </div>

              <div class="quickbar">
                <form action="{% url 'store:add_to_cart' product.id %}" method="post" class="d-inline add-to-cart-form">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-add btn-sm px-3 btn-animated">
                    <span class="spark"></span>
                    <i class="bi bi-cart-plus me-1"></i> Add
                  </button>
                </form>
              </div>
            </div>
          </article>
        </div>
        {% empty %}
        <div class="col">
          <div class="alert alert-warning">No products in this category or price range.</div>
        </div>
        {% endfor %}
      </div>
    </section>
  </div>
</div>

<!-- Back to top -->
<button id="backTop" class="back-top" aria-label="Back to top"><i class="bi bi-arrow-up"></i></button>

<script>
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Price label sync
  (function(){
    const rng=document.getElementById('priceRange'), out=document.getElementById('rangeVal');
    if(rng&&out){ const sync=()=>out.textContent=rng.value; rng.addEventListener('input',sync); sync(); }
  })();

  // Favorites toggle (visual only)
  document.addEventListener('click', (e)=>{
    const fav=e.target.closest('.fav'); if(!fav) return;
    fav.classList.toggle('active');
    const i=fav.querySelector('i'); i.className=fav.classList.contains('active')?'bi bi-heart-fill':'bi bi-heart';
  });

  // Lazy blur & skeleton hide
  document.querySelectorAll('.stage').forEach(stage=>{
    const img=stage.querySelector('img.lazy-blur'); const sk=stage.querySelector('.skeleton');
    if(!img) return;
    const loaded=()=>{ img.classList.add('is-loaded'); if(sk) sk.classList.add('hide'); };
    if(img.complete){ loaded(); } else { img.addEventListener('load', loaded, {once:true}); }
  });

  // Scroll progress bar
  (function(){
    const scn=document.querySelector('.shop-scene'); if(!scn) return;
    const bar=document.querySelector('.scroll-progress');
    const onScroll=()=>{
      const doc=document.documentElement; const max=doc.scrollHeight - doc.clientHeight;
      const p = max>0 ? (window.scrollY / max) : 0;
      bar.style.transform = `scaleX(${p})`;
    };
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
  })();

  // Reveal on scroll
  (function(){
    const els=[...document.querySelectorAll('.reveal')];
    if(!('IntersectionObserver' in window)||!els.length){ els.forEach(e=>e.classList.add('in')); return; }
    const io=new IntersectionObserver((entries)=>{
      entries.forEach(({isIntersecting,target})=>{
        if(isIntersecting){
          const delay=target.dataset.delay||'0.06s';
          target.style.setProperty('--delay', delay);
          target.classList.add('in');
          io.unobserve(target);
        }
      });
    },{root:null,rootMargin:'0px 0px -6% 0px',threshold:.12});
    els.forEach(e=>io.observe(e));
  })();

  // 3D tilt with inertia + glint follow
  (function(){
    const cards=document.querySelectorAll('[data-tilt]'); const max=6;
    cards.forEach(card=>{
      let rx=0, ry=0, tx=0, ty=0, raf;
      const animate=()=>{
        rx += (tx - rx)*0.12; ry += (ty - ry)*0.12;
        card.style.setProperty('--rx', rx.toFixed(2)+'deg'); card.style.setProperty('--ry', ry.toFixed(2)+'deg');
        raf = (Math.abs(tx-rx)+Math.abs(ty-ry)>.01) ? requestAnimationFrame(animate) : null;
      };
      card.addEventListener('pointermove', (e)=>{
        const r=card.getBoundingClientRect();
        const px=(e.clientX - r.left)/r.width, py=(e.clientY - r.top)/r.height;
        ty=(px - .5)*max*2; tx=(.5 - py)*max*2;
        if(!raf) animate();
        const stage=card.querySelector('.stage'); if(stage){
          stage.style.setProperty('--mx', (px*100).toFixed(1)+'%');
          stage.style.setProperty('--my', (py*100).toFixed(1)+'%');
        }
      });
      card.addEventListener('pointerleave', ()=>{ tx=0; ty=0; if(!raf) animate(); });
    });
  })();

  // Magnetic buttons (apply + add)
  (function(){
    const mags = document.querySelectorAll('.btn-apply, .btn-add');
    mags.forEach(btn=>{
      btn.classList.add('mag');
      let leaveTO;
      btn.addEventListener('mousemove', (e)=>{
        const r=btn.getBoundingClientRect();
        const x=e.clientX - (r.left + r.width/2);
        const y=e.clientY - (r.top + r.height/2);
        btn.style.transform = `translate(${x*0.12}px, ${y*0.12}px)`;
        clearTimeout(leaveTO);
      });
      btn.addEventListener('mouseleave', ()=>{
        leaveTO = setTimeout(()=>{ btn.style.transform='translate(0,0)'; }, 60);
      });
    });
  })();

  // Button ripple + confetti micro-burst on submit/click
  (function(){
    const mkRipple=(btn, x, y)=>{
      const r=document.createElement('span'); r.className='ripple';
      r.style.left=x+'px'; r.style.top=y+'px'; btn.appendChild(r);
      r.addEventListener('animationend',()=>r.remove());
    };
    const confetti=(root)=>{
      const n=10; const box=root.getBoundingClientRect();
      for(let i=0;i<n;i++){
        const p=document.createElement('i');
        p.style.position='fixed';
        p.style.left=(box.left+box.width/2)+'px';
        p.style.top=(box.top)+'px';
        p.style.width='6px'; p.style.height='6px'; p.style.borderRadius='50%';
        p.style.background=['#ff7a00','#ffc155','#ff4d6d','#fff'][i%4];
        p.style.pointerEvents='none'; p.style.zIndex=50;
        const dx=(Math.random()-0.5)*160, dy= - (80 + Math.random()*80);
        p.animate([
          { transform:'translate(0,0)', opacity:1 },
          { transform:`translate(${dx}px, ${dy}px)`, opacity:0 }
        ], { duration:700+Math.random()*400, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards' });
        document.body.appendChild(p);
        setTimeout(()=>p.remove(), 1200);
      }
    };

    document.addEventListener('click',(e)=>{
      const btn=e.target.closest('.btn-animated'); if(!btn) return;
      const rect=btn.getBoundingClientRect(); mkRipple(btn, e.clientX-rect.left, e.clientY-rect.top);
    });

    // Celebration on add-to-cart submit (doesn't interfere with your AJAX or normal POST)
    document.addEventListener('submit',(e)=>{
      const form=e.target.closest('form.add-to-cart-form'); if(!form) return;
      const btn=form.querySelector('.btn-animated')||form.querySelector('button[type="submit"]');
      if(btn) confetti(btn);
    }, true);
  })();

  // Back to top
  (function(){
    const btn=document.getElementById('backTop');
    const onScroll=()=> btn.classList.toggle('show', window.scrollY>480);
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
    btn.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
  })();

  // GPU-friendly floating particles
  (function(){
    if(prefersReduced) return;
    const cvs=document.getElementById('snackParticles'); if(!cvs) return;
    const ctx=cvs.getContext('2d');
    let W,H, DPR=Math.min(window.devicePixelRatio||1, 2);
    const P=60; // particles
    const parts=[];
    function resize(){
      const r=cvs.getBoundingClientRect(); W=r.width; H=r.height;
      cvs.width=W*DPR; cvs.height=H*DPR; ctx.scale(DPR,DPR);
    }
    window.addEventListener('resize', resize, {passive:true}); resize();
    for(let i=0;i<P;i++){
      parts.push({ x:Math.random()*W, y:Math.random()*H, r: 1+Math.random()*2.2,
                   vx:(Math.random()-.5)*.25, vy:(Math.random()-.5)*.25, a:.2+Math.random()*.35 });
    }
    function tick(){
      ctx.clearRect(0,0,W,H);
      for(const p of parts){
        p.x+=p.vx; p.y+=p.vy;
        if(p.x< -10) p.x=W+10; if(p.x>W+10) p.x=-10;
        if(p.y< -10) p.y=H+10; if(p.y>H+10) p.y=-10;
        ctx.beginPath();
        ctx.fillStyle=`rgba(255, 200, 150, ${p.a})`;
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      }
      requestAnimationFrame(tick);
    }
    tick();
  })();
</script>

{% endblock %}
