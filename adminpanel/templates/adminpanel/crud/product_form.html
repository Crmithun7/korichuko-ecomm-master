{# templates/adminpanel/crud/product_form.html #}
{% extends "adminpanel/base.html" %}
{% load static %}
{% block title %}{{ object|default_if_none:"New" }} Product{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">{{ object|default_if_none:"New" }} Product</h3>
  <a class="btn btn-outline-secondary" href="{% url 'adminpanel:products' %}">← Back to products</a>
</div>

{% if form.non_field_errors %}
  <div class="alert alert-danger">{{ form.non_field_errors }}</div>
{% endif %}

<div class="card p-3 shadow-sm border-0 rounded-4">
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="row g-3">
      <!-- Name -->
      <div class="col-md-6">
        <label class="form-label" for="{{ form.name.id_for_label }}">Name</label>
        {{ form.name }}
        {% if form.name.errors %}<div class="text-danger small">{{ form.name.errors }}</div>{% endif %}
      </div>

      <!-- Regular Price -->
      <div class="col-md-3">
        <label class="form-label" for="{{ form.regular_price.id_for_label }}">Regular Price</label>
        {{ form.regular_price }}
        {% if form.regular_price.errors %}<div class="text-danger small">{{ form.regular_price.errors }}</div>{% endif %}
      </div>

      <!-- Sale Price -->
      <div class="col-md-3">
        <label class="form-label" for="{{ form.sale_price.id_for_label }}">Sale Price</label>
        {{ form.sale_price }}
        {% if form.sale_price.errors %}<div class="text-danger small">{{ form.sale_price.errors }}</div>{% endif %}
      </div>

      <!-- Flags -->
      <div class="col-md-6 d-flex align-items-end gap-3">
        <div class="form-check">
          {{ form.on_sale }} <label class="form-check-label" for="{{ form.on_sale.id_for_label }}">On sale</label>
        </div>
        <div class="form-check">
          {{ form.is_new }} <label class="form-check-label" for="{{ form.is_new.id_for_label }}">New</label>
        </div>
      </div>

      <!-- Size Value -->
      <div class="col-md-3">
        <label class="form-label" for="{{ form.size_value.id_for_label }}">Size Value</label>
        {{ form.size_value }}
        {% if form.size_value.errors %}<div class="text-danger small">{{ form.size_value.errors }}</div>{% endif %}
      </div>

      <!-- Size (Unit FK) -->
      <div class="col-md-3">
        <label class="form-label" for="{{ form.size.id_for_label }}">Size Unit</label>
        {{ form.size }}
        {% if form.size.errors %}<div class="text-danger small">{{ form.size.errors }}</div>{% endif %}
      </div>

      <!-- Category -->
      <div class="col-md-6">
        <label class="form-label" for="{{ form.category.id_for_label }}">Category</label>
        {{ form.category }}
        {% if form.category.errors %}<div class="text-danger small">{{ form.category.errors }}</div>{% endif %}
      </div>

      <!-- Sub-category -->
      <div class="col-md-6">
        <label class="form-label" for="{{ form.sub_category.id_for_label }}">Sub-category</label>
        {{ form.sub_category }}
        {% if form.sub_category.errors %}<div class="text-danger small">{{ form.sub_category.errors }}</div>{% endif %}
      </div>

      <!-- Description -->
      <div class="col-12">
        <label class="form-label" for="{{ form.description.id_for_label }}">Description</label>
        {{ form.description }}
        {% if form.description.errors %}<div class="text-danger small">{{ form.description.errors }}</div>{% endif %}
      </div>

      {# --------------------- IMAGE PICKER + EXISTING IMAGE --------------------- #}
      <div class="col-md-6">
        <label class="form-label" for="{{ form.image.id_for_label }}">Image</label>
        {{ form.image }}

        <div id="existingImageControls" class="mt-2"
             style="{% if not form.instance.image %}display:none{% endif %}">
          <div class="d-flex align-items-center gap-3">
            <img id="existingImageThumb"
                 src="{% if form.instance.image %}{{ form.instance.image.url }}{% endif %}"
                 alt="Current image"
                 style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #e5e5e5">
            <button type="button" class="btn btn-sm btn-outline-danger" id="clearExistingBtn">
              Clear current image
            </button>
          </div>
        </div>
        {% if form.image.errors %}<div class="text-danger small">{{ form.image.errors }}</div>{% endif %}
      </div>

      {# --------------------- LIVE PREVIEW (NEW SELECTION) --------------------- #}
      <div class="col-md-6">
        <label class="form-label d-block">Image Preview (new selection)</label>
        <div id="dropZone" class="border rounded-3 p-3 text-center"
             style="border-style:dashed; background:#fafafa;">
          <div class="small text-muted mb-2">Drag & drop an image here, or use the file picker.</div>
          <img id="imagePreview"
               src=""
               alt="Preview"
               style="max-width: 240px; max-height: 240px; display:none; border:1px solid #eee; border-radius:8px;">
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="removePreviewBtn"
                    style="display:none">Remove selection</button>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-success">Save</button>
      <a href="{% url 'adminpanel:products' %}" class="btn btn-outline-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
(function(){
  // Use the ID Django generated for the image field
  let inputId    = "{{ form.image.id_for_label }}"; // e.g., "id_image"
  let input      = document.getElementById(inputId);
  const preview  = document.getElementById("imagePreview");
  const removeBtn= document.getElementById("removePreviewBtn");
  const dropZone = document.getElementById("dropZone");

  // Existing image (edit mode)
  const existingWrap = document.getElementById("existingImageControls");
  const clearExistingBtn = document.getElementById("clearExistingBtn");

  // Django's ClearableFileInput uses name="image-clear" on edit
  const clearCheckbox = document.querySelector('input[type="checkbox"][name="image-clear"]');

  // Make picker friendlier
  if (input) input.setAttribute("accept", "image/*");

  function showPreviewFromFile(file){
    if (!file) return;
    if (!file.type || !file.type.startsWith("image/")) {
      alert("Please choose an image file.");
      return;
    }
    if (file.size > 5 * 1024 * 1024) { // 5MB
      alert("Image too large (max 5MB).");
      return;
    }
    const url = URL.createObjectURL(file);
    preview.src = url;
    preview.style.display = "inline-block";
    removeBtn.style.display = "inline-block";
  }

  function rebindInput(el){
    el.addEventListener("change", onInputChange);
    input = el; // update reference
  }

  function clearNewSelection(){
    if (input) {
      const newInput = input.cloneNode(true);
      newInput.value = "";
      input.parentNode.replaceChild(newInput, input);
      rebindInput(newInput);
    }
    preview.src = "";
    preview.style.display = "none";
    removeBtn.style.display = "none";
  }

  function onInputChange(e){
    const file = e.target.files && e.target.files[0];
    if (file) {
      showPreviewFromFile(file);
      if (clearCheckbox) clearCheckbox.checked = false; // user picked new file → don't clear old via checkbox
    } else {
      clearNewSelection();
    }
  }

  if (input) rebindInput(input);

  if (removeBtn) {
    removeBtn.addEventListener("click", function(){
      clearNewSelection();
    });
  }

  // Drag & drop
  if (dropZone) {
    ["dragenter","dragover"].forEach(evt=>{
      dropZone.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        dropZone.classList.add("border-success");
      });
    });
    ["dragleave","drop"].forEach(evt=>{
      dropZone.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        dropZone.classList.remove("border-success");
      });
    });
    dropZone.addEventListener("drop", e=>{
      const dt = e.dataTransfer;
      if (!dt || !dt.files || !dt.files[0]) return;
      const file = dt.files[0];
      showPreviewFromFile(file);

      // Put the dropped file into the input so Django uploads it
      if (input && window.DataTransfer) {
        const d = new DataTransfer();
        d.items.add(file);
        input.files = d.files;
        if (clearCheckbox) clearCheckbox.checked = false;
      }
    });
  }

  // Clear EXISTING image (edit mode)
  if (clearExistingBtn) {
    clearExistingBtn.addEventListener("click", function(){
      if (clearCheckbox) clearCheckbox.checked = true; // tell Django to clear on save
      if (existingWrap) existingWrap.style.display = "none"; // hide the existing thumb
    });
  }
})();
</script>
{% endblock %}
