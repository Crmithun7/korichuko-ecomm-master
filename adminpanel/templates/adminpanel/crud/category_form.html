{% extends "adminpanel/base.html" %}
{% block title %}Category{% endblock %}

{% block content %}
<h3 class="mb-3">{{ object|default_if_none:"New" }} Category</h3>
<div class="card p-3 shadow-sm border-0 rounded-4">
  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="row g-3">
      <div class="col-md-6">
        {{ form.name.label_tag }}{{ form.name }}
      </div>
      <div class="col-md-6">
        {{ form.slug.label_tag }}{{ form.slug }}
      </div>

      {# --------------------- IMAGE PICKER + EXISTING IMAGE --------------------- #}
      <div class="col-md-6">
        <label class="form-label" for="{{ form.image.id_for_label }}">Image</label>
        {{ form.image }}
        <div id="existingImageControls" class="mt-2"
             style="{% if not form.instance.image %}display:none{% endif %}">
          <div class="d-flex align-items-center gap-3">
            <img id="existingImageThumb"
                 src="{% if form.instance.image %}{{ form.instance.image.url }}{% endif %}"
                 alt="Current image"
                 style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #e5e5e5">
            <button type="button" class="btn btn-sm btn-outline-danger" id="clearExistingBtn">
              Clear current image
            </button>
          </div>
        </div>
        {% if form.image.errors %}<div class="text-danger small">{{ form.image.errors }}</div>{% endif %}
      </div>

      {# --------------------- LIVE PREVIEW (NEW SELECTION) --------------------- #}
      <div class="col-md-6">
        <label class="form-label d-block">Image Preview (new selection)</label>
        <div id="dropZone" class="border rounded-3 p-3 text-center"
             style="border-style:dashed; background:#fafafa;">
          <div class="small text-muted mb-2">Drag & drop an image here, or use the file picker.</div>
          <img id="imagePreview"
               src=""
               alt="Preview"
               style="max-width: 240px; max-height: 240px; display:none; border:1px solid #eee; border-radius:8px;">
          <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="removePreviewBtn"
                    style="display:none">Remove selection</button>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3">
      <a href="{% url 'adminpanel:categories' %}" class="btn btn-outline-secondary">Cancel</a>
      <button class="btn btn-success">Save</button>
    </div>
  </form>
</div>

<script>
(function(){
  // Use Django's generated ID for the file input
  let inputId    = "{{ form.image.id_for_label }}";
  let input      = document.getElementById(inputId);
  const preview  = document.getElementById("imagePreview");
  const removeBtn= document.getElementById("removePreviewBtn");
  const dropZone = document.getElementById("dropZone");

  // Existing image (edit mode)
  const existingWrap = document.getElementById("existingImageControls");
  const clearExistingBtn = document.getElementById("clearExistingBtn");

  // Django's ClearableFileInput uses name="image-clear" on edit
  const clearCheckbox = document.querySelector('input[type="checkbox"][name="image-clear"]');

  if (input) input.setAttribute("accept", "image/*");

  function showPreviewFromFile(file){
    if (!file) return;
    if (!file.type || !file.type.startsWith("image/")) { alert("Please choose an image file."); return; }
    if (file.size > 5 * 1024 * 1024) { alert("Image too large (max 5MB)."); return; }
    const url = URL.createObjectURL(file);
    preview.src = url;
    preview.style.display = "inline-block";
    removeBtn.style.display = "inline-block";
  }

  function rebindInput(el){
    el.addEventListener("change", onInputChange);
    input = el;
  }

  function clearNewSelection(){
    if (input) {
      const newInput = input.cloneNode(true);
      newInput.value = "";
      input.parentNode.replaceChild(newInput, input);
      rebindInput(newInput);
    }
    preview.src = "";
    preview.style.display = "none";
    removeBtn.style.display = "none";
  }

  function onInputChange(e){
    const file = e.target.files && e.target.files[0];
    if (file) {
      showPreviewFromFile(file);
      if (clearCheckbox) clearCheckbox.checked = false; // new file => don't clear old
    } else {
      clearNewSelection();
    }
  }

  if (input) rebindInput(input);

  if (removeBtn) removeBtn.addEventListener("click", clearNewSelection);

  // Drag & drop
  if (dropZone) {
    ["dragenter","dragover"].forEach(evt=>{
      dropZone.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation(); dropZone.classList.add("border-success");
      });
    });
    ["dragleave","drop"].forEach(evt=>{
      dropZone.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation(); dropZone.classList.remove("border-success");
      });
    });
    dropZone.addEventListener("drop", e=>{
      const dt = e.dataTransfer;
      if (!dt || !dt.files || !dt.files[0]) return;
      const file = dt.files[0];
      showPreviewFromFile(file);
      if (input && window.DataTransfer) {
        const d = new DataTransfer(); d.items.add(file); input.files = d.files;
        if (clearCheckbox) clearCheckbox.checked = false;
      }
    });
  }

  // Clear EXISTING image (edit mode)
  if (clearExistingBtn) {
    clearExistingBtn.addEventListener("click", function(){
      if (clearCheckbox) clearCheckbox.checked = true;
      if (existingWrap) existingWrap.style.display = "none";
    });
  }
})();
</script>
{% endblock %}
